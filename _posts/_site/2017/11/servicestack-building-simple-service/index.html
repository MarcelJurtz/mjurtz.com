<p>This is the second post in my series on building web services with ServiceStack. In <a href="https://blog.mjurtz.com/2017/11/what-is-servicestack/">the first part</a>, I covered the benefits of using ServiceStack, this article continues with the setup of a basic service and its several components.</p>

<p>In this and the following parts I will create a simple example project to illustrate the use of servicestack. This project will be an expenses tracker. In this part, we will develop the functionality to add expenses and establish an overall balance. In the following part we will combine them with the C# client.</p>

<p>The source code for this and the following parts can be found in <a href="https://github.com/MarcelJurtz/BlogPosts_ServiceStack">this GitHub repository</a>, where I will create a separate folder for each article. Since this is the second part of the tutorial, you’ll find the source code for todays article in the folder <a href="https://github.com/MarcelJurtz/BlogPosts_ServiceStack/tree/master/Part_2_Basic_Service">Part_2_Basic_Service</a>.</p>

<h2 id="servicestack-service-architecture">ServiceStack Service Architecture</h2>

<p>Before we can create our first service, we need a basic understanding of how these work in ServiceStack. Basically, each service consists of three elements: a request, a response and an actual service. The request describes the object which is sent to the service, which proceeds the request and returns a reponse. We’ll add a simple service to our project in the next step.</p>

<h2 id="setting-up-the-server">Setting up the Server</h2>

<p>Let’s get right into development, where we’ll start with the implementation of the server. Start by creating an empty ASP.NET web application in Visual Studio. There are some things you’ll want to do now: First of all, install ServiceStack via nuget package manager. After that, adjust your web.config file so that it matches mine:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="c">&lt;!--
  Informationen zur Konfiguration Ihrer ASP.NET-Anwendung finden Sie unter
  https://go.microsoft.com/fwlink/?LinkId=169433
  --&gt;</span>
<span class="nt">&lt;configuration&gt;</span>
  <span class="nt">&lt;system.web&gt;</span>
    <span class="nt">&lt;httpHandlers&gt;</span>
      <span class="nt">&lt;add</span> <span class="na">path=</span><span class="s">"*"</span> <span class="na">type=</span><span class="s">"ServiceStack.HttpHandlerFactory, ServiceStack"</span> <span class="na">verb=</span><span class="s">"*"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/httpHandlers&gt;</span>
    <span class="nt">&lt;compilation</span> <span class="na">debug=</span><span class="s">"true"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/system.web&gt;</span>
  <span class="c">&lt;!-- Required for IIS7 --&gt;</span>
  <span class="nt">&lt;system.webServer&gt;</span>
    <span class="nt">&lt;modules</span> <span class="na">runAllManagedModulesForAllRequests=</span><span class="s">"true"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;validation</span> <span class="na">validateIntegratedModeConfiguration=</span><span class="s">"false"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;handlers&gt;</span>
      <span class="nt">&lt;add</span> <span class="na">path=</span><span class="s">"*"</span> <span class="na">name=</span><span class="s">"ServiceStack.Factory"</span> <span class="na">type=</span><span class="s">"ServiceStack.HttpHandlerFactory, ServiceStack"</span> <span class="na">verb=</span><span class="s">"*"</span> <span class="na">preCondition=</span><span class="s">"integratedMode"</span> <span class="na">resourceType=</span><span class="s">"Unspecified"</span> <span class="na">allowPathInfo=</span><span class="s">"true"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/handlers&gt;</span>
  <span class="nt">&lt;/system.webServer&gt;</span>
<span class="nt">&lt;/configuration&gt;</span></code></pre></figure>

<p>The next step is to add a global.asax file. Do so by right-clicking your project – add new item – global.asax. In this file, the service going to be instantiated. However, you’ll  first need a service which can be instantiated. Let’s do so by adding our service class: <em>ExpensesService.cs</em>. This service is created as described in the previous section:</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">public</span> <span class="k">class</span> <span class="nc">ExpensesService</span> <span class="p">:</span> <span class="n">Service</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">object</span> <span class="nf">Post</span><span class="p">(</span><span class="n">Expense</span> <span class="n">request</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">ExpenseResponse</span>
        <span class="p">{</span>
            <span class="n">Amount</span> <span class="p">=</span> <span class="n">request</span><span class="p">.</span><span class="n">Amount</span><span class="p">,</span>
            <span class="n">Total</span> <span class="p">=</span> <span class="m">500</span><span class="p">,</span>
            <span class="n">Status</span> <span class="p">=</span> <span class="s">"OK"</span>
        <span class="p">};</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">Expense</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">double</span> <span class="n">Amount</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">ExpenseResponse</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">double</span> <span class="n">Amount</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">double</span> <span class="n">Total</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="n">String</span> <span class="n">Status</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>This service basically takes an amount as input for its request, and returns a new response object with a <em>Total</em> of 500 and the <em>status</em> <em>“OK”</em>. Of course, there is no logic in here currently, this will be added later. For now, we’ll just want do get the service running.</p>

<p>Another thing which we need to set up is the previously created global.asax file. Simply add the following code inside the AppHostBase-class (the overriden class should already be there, you don’t need to set this up manually).</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">public</span> <span class="k">class</span> <span class="nc">ExpenseTrackerAppHost</span> <span class="p">:</span> <span class="n">AppHostBase</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">ExpenseTrackerAppHost</span><span class="p">()</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="s">"Expense Tracker"</span><span class="p">,</span> <span class="k">typeof</span><span class="p">(</span><span class="n">ExpensesService</span><span class="p">).</span><span class="n">Assembly</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
    <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Configure</span><span class="p">(</span><span class="n">Funq</span><span class="p">.</span><span class="n">Container</span> <span class="n">container</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// Configure Application</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">protected</span> <span class="k">void</span> <span class="nf">Application_Start</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">EventArgs</span> <span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">new</span> <span class="nf">ExpenseTrackerAppHost</span><span class="p">().</span><span class="nf">Init</span><span class="p">();</span>
<span class="p">}</span></code></pre></figure>

<h2 id="the-meta-page">The Meta Page</h2>

<p>By now, the service should be able to run. When starting the project, you should be able to see a window like the following:</p>

<p><img src="/assets/2017/servicestack_simple_service_01.png" alt="The ServiceStack Meta Page" /></p>

<p>This overview provides information on all available services in our application. By clicking on the <em>JSON</em>-entry of the Expense-Operation, information about the service is displayed.</p>

<p><img src="/assets/2017/servicestack_simple_service_02.png" alt="The ServiceStack Meta Page - Detail" /></p>

<p>As you can see, this gives plenty of information on the service, including its route (/json/reply/Expense), its HTTP-verb (POST) and its parameters. Also, it shows us how the response-object will look like.</p>

<h2 id="testing-with-postman">Testing with Postman</h2>

<p>To try this out, I use a tool called <a href="https://www.getpostman.com/">Postman</a>, which you can download as extension for chrome, but I recommend the standalone version, since the plugin is outdated. Postman allows us to test our routes and objects with the several HTTP-verbs and optional parameters.</p>

<p><img src="/assets/2017/servicestack_simple_service_03.png" alt="Testing ServiceStack with Postman" /></p>

<p>As you can see in the image, I set the HTTP-verb to POST and added the previously noted route. I also added an “Amount”-parameter, which ServiceStack then maps to the POCOs pendant. The response we get displays pretty much what we’ve expected.</p>

<h2 id="adjusting-the-routes">Adjusting the Routes</h2>

<p>One thing that bothers me here, is the fixed route which looks pretty ugly. We can adjust this by adding a [Route]-Attribute to our service.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="na">[Route("/Expense")]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">Expense</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">double</span> <span class="n">Amount</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>You can also specify multiple routes for one object, by adding curly braces you can add variables. If you want a variable to be optional, simply add an asterisk after the variable name. In the following example, both routes could be combined that way.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="na">[Route("/Expense")]</span>
<span class="na">[Route("/Expense/{Amount}")]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">Expense</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">double</span> <span class="n">Amount</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Finally, note that ServiceStack doesn’t recognize the format any longer with these custom routes. To clarify, what format you’ll want to receive, simply add its ending to the route, like this: /Expense.json.</p>

<p>So that’s it for todays post, the next one adds the C#-Client to easily communicate between C#-applications!</p>
