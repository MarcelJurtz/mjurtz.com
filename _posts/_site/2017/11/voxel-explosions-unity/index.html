<p>This article describes the process of creating voxel explosions in Unity by using particles. For our models, we use <a href="https://ephtracy.github.io/">MagicaVoxel</a>, but every other tool can be used as well. The final result will look similar to this:</p>

<iframe width="560" height="315" src="https://www.youtube.com/embed/n4mzQTFuP68?rel=0&amp;controls=0&amp;showinfo=0" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen=""></iframe>

<h2 id="setting-up-the-test-environment">Setting up the test environment</h2>

<p>For test purposes, I’ve set up a basic FPS environment using the built-in CharacterController package. I then added a gun model to the <em>FirstPersonCharacter _game object, which is located as child element in the hierarchy of the _FPSController</em>. The following snippet shows the code I added as a custom script component to the gun:</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">GunScript</span> <span class="p">:</span> <span class="n">MonoBehaviour</span> <span class="p">{</span>

    <span class="k">public</span> <span class="n">Camera</span> <span class="n">FPSCamera</span><span class="p">;</span>
    <span class="k">public</span> <span class="kt">float</span> <span class="n">maxDistance</span> <span class="p">=</span> <span class="m">100f</span><span class="p">;</span>

    <span class="k">public</span> <span class="n">AudioClip</span> <span class="n">shot</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">fireRate</span> <span class="p">=</span> <span class="m">0.5f</span><span class="p">;</span>
    <span class="k">private</span> <span class="kt">float</span> <span class="n">nextFire</span> <span class="p">=</span> <span class="m">0.0f</span><span class="p">;</span>
    <span class="k">private</span> <span class="n">Transform</span> <span class="n">t</span><span class="p">;</span>

    <span class="k">void</span> <span class="nf">Start</span> <span class="p">()</span> <span class="p">{</span>
        <span class="n">t</span> <span class="p">=</span> <span class="n">transform</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">void</span> <span class="nf">Update</span> <span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">Input</span><span class="p">.</span><span class="nf">GetButtonDown</span><span class="p">(</span><span class="s">"Fire1"</span><span class="p">)</span> <span class="p">&amp;&amp;</span> <span class="nf">IsOkToShoot</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="nf">Shoot</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">void</span> <span class="nf">Shoot</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">AudioSource</span><span class="p">.</span><span class="nf">PlayClipAtPoint</span><span class="p">(</span><span class="n">shot</span><span class="p">,</span> <span class="n">t</span><span class="p">.</span><span class="n">position</span><span class="p">);</span>
        <span class="n">RaycastHit</span> <span class="n">rcHit</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">Physics</span><span class="p">.</span><span class="nf">Raycast</span><span class="p">(</span><span class="n">FPSCamera</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">position</span><span class="p">,</span> <span class="n">FPSCamera</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">forward</span><span class="p">,</span> <span class="k">out</span> <span class="n">rcHit</span><span class="p">,</span> <span class="n">maxDistance</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="n">rcHit</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">tag</span> <span class="p">==</span> <span class="s">"Enemy"</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">ExplosionScript</span> <span class="n">ex</span> <span class="p">=</span> <span class="n">rcHit</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">gameObject</span><span class="p">.</span><span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">ExplosionScript</span><span class="p">&gt;();</span>
                
                <span class="k">if</span><span class="p">(</span><span class="n">ex</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">ex</span><span class="p">.</span><span class="nf">Explode</span><span class="p">(</span><span class="n">rcHit</span><span class="p">.</span><span class="n">point</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kt">bool</span> <span class="nf">IsOkToShoot</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="kt">bool</span> <span class="n">fireable</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">Time</span><span class="p">.</span><span class="n">time</span> <span class="p">&gt;</span> <span class="n">nextFire</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">nextFire</span> <span class="p">=</span> <span class="n">Time</span><span class="p">.</span><span class="n">time</span> <span class="p">+</span> <span class="n">fireRate</span><span class="p">;</span>
            <span class="n">fireable</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">fireable</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>So basically, this script takes up three public variables, one for the camera of the controller, which is needed to shoot from the player’s perspective, a maxDistance to set how far can be shot, and an AudioClip to play a sound file when a shot has been fired. Additionally, there are a few private variables:</p>

<ul>
  <li><em>fireRate,</em> to set how fast shots can be fired after each other</li>
  <li><em>nextFire</em>, which is used to determine when a shot can be fired</li>
  <li><em>t</em>, which represents the transform component of the current gameObject</li>
</ul>

<p>Every frame I check if the left mouse button is pressed. If so, a shot should be fired if the method <em>IsOkToShoot()</em> returns <em>true</em>. This happens when the current time minus the last time shot is larger than the previously set <em>fireRate</em>.</p>

<p>When an actual shot happens, the sound is being played where <em>t.position</em> determines the location from where the shot is going to be heard. After that, I call up a ray cast to scan the targeted environment for possible targets. The outgoing argument <em>hit</em> provides information about the target that has been hit (if nothing has been hit, the code inside the outermost if-statement will not be executed).</p>

<p>I created a custom tag called <em>Enemy</em>, which is going to be added to all the objects I want to hit. These are going to get a custom script called <em>ExplosionScript</em>, which contains a method named <em>Explode</em>. The next step is to build this script and actually blow something up.</p>

<h2 id="exploding-voxels">Exploding Voxels</h2>

<p>I’m using a basic model for testing purposes, that can bee seen in the screenshot below.</p>

<p><img src="/assets/2017/voxel_explosion_1.png" alt="Voxel Explosion - Unity Prefab" /></p>

<p>It currently consists of an empty <em>GameObject</em> as parent, which has been expaned by adding a <em>MeshCollider</em>. The child element contains the actual content.</p>

<p>At first, a <em>ParticleSystem</em> is going to be added to the object. I use the following configuration here:</p>

<p><img src="/assets/2017/voxel_explosion_2.png" alt="Voxel Explosion - Unity Prefab Settings" /></p>

<p>Note that the last setting (shader) can’t be set yet. That will be created later. Also, <em>ExplosionMat</em> is just a regular material. After configuring the <em>ParticleSystem</em>, the animation should look like some cubes exploding and falling on the ground. Now the colors of the cubes need to be adjusted. The problem is, that a custom shader and a bit of additional coding is needed here. Now you just create a new prefab and move the <em>ParticleSystem</em> onto it. Then delete it from the object that has been used for testing.</p>

<p>I’ll start with the shader. You use the context menu and add a new <em>shader</em> – <em>standard surface shader</em>. You can open the newly created file with Visual Studio (or whatever editor you want) and edit it to match our plan:</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="n">Shader</span> <span class="s">"Custom/ExplosionShader"</span> <span class="p">{</span>
    <span class="n">Properties</span> <span class="p">{</span>
        <span class="nf">_Color</span> <span class="p">(</span><span class="s">"Color"</span><span class="p">,</span> <span class="n">Color</span><span class="p">)</span> <span class="p">=</span> <span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">1</span><span class="p">)</span>
        <span class="nf">_MainTex</span> <span class="p">(</span><span class="s">"Albedo (RGB)"</span><span class="p">,</span> <span class="m">2D</span><span class="p">)</span> <span class="p">=</span> <span class="s">"white"</span> <span class="p">{}</span>
        <span class="nf">_Glossiness</span> <span class="p">(</span><span class="s">"Smoothness"</span><span class="p">,</span> <span class="nf">Range</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">1</span><span class="p">))</span> <span class="p">=</span> <span class="m">0.5</span>
        <span class="nf">_Metallic</span> <span class="p">(</span><span class="s">"Metallic"</span><span class="p">,</span> <span class="nf">Range</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">1</span><span class="p">))</span> <span class="p">=</span> <span class="m">0.0</span>
    <span class="p">}</span>
    <span class="n">SubShader</span> <span class="p">{</span>
        <span class="n">Tags</span> <span class="p">{</span> <span class="s">"RenderType"</span><span class="p">=</span><span class="s">"Opaque"</span> <span class="p">}</span>
        <span class="n">LOD</span> <span class="m">200</span>
        
        <span class="n">CGPROGRAM</span>
        <span class="c1">// Physically based Standard lighting model, and enable shadows on all light types
</span>
        <span class="err">#</span><span class="n">pragma</span> <span class="n">surface</span> <span class="n">surf</span> <span class="n">Standard</span> <span class="n">fullforwardshadows</span>

        <span class="c1">// Use shader model 3.0 target, to get nicer looking lighting
</span>
        <span class="err">#</span><span class="n">pragma</span> <span class="n">target</span> <span class="m">3.0</span>

        <span class="n">sampler2D</span> <span class="n">_MainTex</span><span class="p">;</span>

        <span class="k">struct</span> <span class="nc">Input</span> <span class="p">{</span>
            <span class="n">float2</span> <span class="n">uv_MainTex</span><span class="p">;</span>
            
            <span class="c1">// NEW LINE
</span>
            <span class="n">float4</span> <span class="n">vertexColor</span> <span class="p">:</span> <span class="n">COLOR</span><span class="p">;</span>
        <span class="p">};</span>

        <span class="n">half</span> <span class="n">_Glossiness</span><span class="p">;</span>
        <span class="n">half</span> <span class="n">_Metallic</span><span class="p">;</span>
        <span class="n">fixed4</span> <span class="n">_Color</span><span class="p">;</span>

        <span class="k">void</span> <span class="nf">surf</span> <span class="p">(</span><span class="n">Input</span> <span class="n">IN</span><span class="p">,</span> <span class="n">inout</span> <span class="n">SurfaceOutputStandard</span> <span class="n">o</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Albedo comes from a texture tinted by color
</span>
            <span class="n">fixed4</span> <span class="n">c</span> <span class="p">=</span> <span class="nf">tex2D</span> <span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">IN</span><span class="p">.</span><span class="n">uv_MainTex</span><span class="p">)</span> <span class="p">*</span> <span class="n">_Color</span><span class="p">;</span>
            
            <span class="c1">// NEW LINE:
</span>
            <span class="n">c</span> <span class="p">*=</span> <span class="n">IN</span><span class="p">.</span><span class="n">vertexColor</span><span class="p">;</span>


            <span class="n">o</span><span class="p">.</span><span class="n">Albedo</span> <span class="p">=</span> <span class="n">c</span><span class="p">.</span><span class="n">rgb</span><span class="p">;</span>
            <span class="c1">// Metallic and smoothness come from slider variables
</span>
            <span class="n">o</span><span class="p">.</span><span class="n">Metallic</span> <span class="p">=</span> <span class="n">_Metallic</span><span class="p">;</span>
            <span class="n">o</span><span class="p">.</span><span class="n">Smoothness</span> <span class="p">=</span> <span class="n">_Glossiness</span><span class="p">;</span>
            <span class="n">o</span><span class="p">.</span><span class="n">Alpha</span> <span class="p">=</span> <span class="n">c</span><span class="p">.</span><span class="n">a</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">ENDCG</span>
    <span class="p">}</span>
    <span class="n">FallBack</span> <span class="s">"Diffuse"</span>
<span class="p">}</span></code></pre></figure>

<p>There are two lines that need to be adjusted, I’ve marked them with the comment <em>//NEW LINE</em>. After that, the currently used material for the particles should be set to the color white. The color that is going to be set later will be mixed with the default color, and if that isn’t white the colors won’t match our wanted ones. Also, the shader of the material needs to be set to the newly created one.</p>

<p>An additional script is needed to edit the palette.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">ExplosionScript</span> <span class="p">:</span> <span class="n">MonoBehaviour</span> <span class="p">{</span>

    <span class="k">public</span> <span class="n">GameObject</span> <span class="n">explosionPrefab</span><span class="p">;</span>
    <span class="k">private</span> <span class="n">GameObject</span> <span class="n">explosion</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">exploding</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>

    <span class="k">public</span> <span class="kt">string</span> <span class="n">colorDescriptor</span><span class="p">;</span>
    <span class="k">private</span> <span class="n">Color32</span><span class="p">[]</span> <span class="n">colors</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">Explode</span><span class="p">(</span><span class="n">Vector3</span> <span class="n">pos</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">explosion</span> <span class="p">=</span> <span class="nf">Instantiate</span><span class="p">(</span><span class="n">explosionPrefab</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">Quaternion</span><span class="p">.</span><span class="nf">Euler</span><span class="p">(</span><span class="m">0f</span><span class="p">,</span><span class="m">0f</span><span class="p">,</span><span class="m">0f</span><span class="p">));</span>
        <span class="n">exploding</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>       
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">void</span> <span class="nf">LateUpdate</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">exploding</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">ParticleSystem</span> <span class="n">explosionParticleSystem</span> <span class="p">=</span> <span class="n">explosion</span><span class="p">.</span><span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">ParticleSystem</span><span class="p">&gt;();</span>
            <span class="n">ParticleSystem</span><span class="p">.</span><span class="n">Particle</span><span class="p">[]</span> <span class="n">particles</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ParticleSystem</span><span class="p">.</span><span class="n">Particle</span><span class="p">[</span><span class="n">explosionParticleSystem</span><span class="p">.</span><span class="n">main</span><span class="p">.</span><span class="n">maxParticles</span><span class="p">];</span>
            <span class="n">colors</span> <span class="p">=</span> <span class="n">ColorManager</span><span class="p">.</span><span class="nf">getColor</span><span class="p">(</span><span class="n">colorDescriptor</span><span class="p">);</span>
            <span class="kt">int</span> <span class="n">numParticlesAlive</span> <span class="p">=</span> <span class="n">explosionParticleSystem</span><span class="p">.</span><span class="nf">GetParticles</span><span class="p">(</span><span class="n">particles</span><span class="p">);</span>
            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">numParticlesAlive</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
            <span class="p">{</span>
                <span class="n">particles</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">startColor</span> <span class="p">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">Random</span><span class="p">.</span><span class="nf">Range</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">colors</span><span class="p">.</span><span class="n">Length</span><span class="p">)];</span>
            <span class="p">}</span>
            <span class="n">explosionParticleSystem</span><span class="p">.</span><span class="nf">SetParticles</span><span class="p">(</span><span class="n">particles</span><span class="p">,</span> <span class="n">numParticlesAlive</span><span class="p">);</span>
            <span class="n">exploding</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>

            <span class="nf">Destroy</span><span class="p">(</span><span class="n">gameObject</span><span class="p">);</span>
        <span class="p">}</span>       
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Again, here are some public and private variables:</p>

<ul>
  <li><em>explosionPrefab</em> represents the prefab containing the ParticleSystem</li>
  <li><em>explosion</em> is an instance of the prefab</li>
  <li><em>exploding</em> is a flag for controlling the explosion</li>
  <li><em>colors</em> is an array containing the colors that are going to be assigned to the exploding particles</li>
</ul>

<p>The first method starts the explosion. It instantiates the explosion at a given position, which is going to be where the ray cast hit the object. In <em>LateUpdate()</em>, the particles are going to be painted. This method is only run, when the exploding-flag is set to <em>true</em>, and it is also run only once, which is why the flag is set to <em>false</em> again at the end.</p>

<p>The <em>gameObject</em> itself is destroyed in the very end, since it is needed to assign its properties to the <em>ParticleSystem</em> created at runtime.</p>

<p>All the particles of the explosion are collected inside the <em>particles _array. The for-loop is iterating through all of the particles and assigns a new color. The color is determined via random selection of a color of the above-mentioned array. I found this solution to be a bit ugly, so I created another script called _ColorManager</em>, which contains arrays for each of my models. It basically just contains the following code:</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">private</span> <span class="k">static</span> <span class="n">Color32</span><span class="p">[]</span> <span class="n">foxColors</span> <span class="p">=</span>
<span class="p">{</span>
    <span class="k">new</span> <span class="nf">Color32</span><span class="p">(</span><span class="m">238</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">255</span><span class="p">),</span>
    <span class="k">new</span> <span class="nf">Color32</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">34</span><span class="p">,</span> <span class="m">255</span><span class="p">),</span>
    <span class="k">new</span> <span class="nf">Color32</span><span class="p">(</span><span class="m">238</span><span class="p">,</span><span class="m">238</span><span class="p">,</span><span class="m">238</span><span class="p">,</span><span class="m">255</span><span class="p">),</span>
    <span class="k">new</span> <span class="nf">Color32</span><span class="p">(</span><span class="m">187</span><span class="p">,</span><span class="m">187</span><span class="p">,</span><span class="m">187</span><span class="p">,</span><span class="m">255</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">private</span> <span class="k">static</span> <span class="n">Color32</span><span class="p">[]</span> <span class="n">chickenColors</span> <span class="p">=</span>
<span class="p">{</span>
    <span class="k">new</span> <span class="nf">Color32</span><span class="p">(</span><span class="m">238</span><span class="p">,</span><span class="m">238</span><span class="p">,</span><span class="m">238</span><span class="p">,</span><span class="m">255</span><span class="p">),</span>
    <span class="k">new</span> <span class="nf">Color32</span><span class="p">(</span><span class="m">238</span><span class="p">,</span><span class="m">0</span><span class="p">,</span><span class="m">0</span><span class="p">,</span><span class="m">255</span><span class="p">),</span>
    <span class="k">new</span> <span class="nf">Color32</span><span class="p">(</span><span class="m">255</span><span class="p">,</span><span class="m">102</span><span class="p">,</span><span class="m">0</span><span class="p">,</span><span class="m">255</span><span class="p">),</span>
    <span class="k">new</span> <span class="nf">Color32</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">0</span><span class="p">,</span><span class="m">17</span><span class="p">,</span><span class="m">255</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">private</span> <span class="k">static</span> <span class="n">Color32</span><span class="p">[]</span> <span class="n">emptyColors</span> <span class="p">=</span>
<span class="p">{</span>
    <span class="k">new</span> <span class="nf">Color32</span><span class="p">(</span><span class="m">255</span><span class="p">,</span><span class="m">255</span><span class="p">,</span><span class="m">255</span><span class="p">,</span><span class="m">255</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">public</span> <span class="k">static</span> <span class="n">Color32</span><span class="p">[]</span> <span class="nf">getColor</span><span class="p">(</span><span class="kt">string</span> <span class="n">colorDescription</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">switch</span><span class="p">(</span><span class="n">colorDescription</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">case</span> <span class="s">"fox"</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">foxColors</span><span class="p">;</span>
        <span class="k">case</span> <span class="s">"chicken"</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">chickenColors</span><span class="p">;</span>
        <span class="k">default</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">emptyColors</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p> </p>

<p>Note that you can view the colors that have been used using MagicaVoxel by clicking on the tool marked by a <em>smaller-than sign</em> and then clicking on <em>HSV</em>.</p>

<p><img src="/assets/2017/voxel_explosion_3.png" alt="Voxel Explosion - MagicaVoxel Color Palette" /></p>

<p>If this is done, the explosions should work!</p>
