<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.88.1" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Voxel Explosions in Unity &middot; Marcel Jurtz</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://www.mjurtz.com/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://www.mjurtz.com/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://www.mjurtz.com/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://www.mjurtz.com/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  
</head>

  <body class=" ">
  <aside class="sidebar">
    <div class="container sidebar-sticky">
        <div class="sidebar-about">
            <a href="https://www.mjurtz.com/">
                <h1>Marcel Jurtz</h1>
            </a>
            <p class="lead">
                 Notes and thoughts on software development 
            </p>
        </div>

        <nav>
            <ul class="sidebar-nav">
                <li><a href="https://www.mjurtz.com/">Home</a> </li>
                <li><a href="/about/"> About </a></li><li><a href="/imprint/"> Imprint / Impressum </a></li><li><a href="/privacy/"> Privacy / Datenschutz </a></li>
            </ul>
        </nav>

    </div>
</aside>
    <main class="content container">
    <div class="post">
  <h1>Voxel Explosions in Unity</h1>
  <time datetime=2017-11-16T18:00:04Z class="post-date">Thu, Nov 16, 2017</time>
  <p>This article describes the process of creating voxel explosions in Unity by using particles. For our models, we use <a href="https://ephtracy.github.io/">MagicaVoxel</a>, but every other tool can be used as well. The final result will look similar to this:</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/n4mzQTFuP68?rel=0&amp;controls=0&amp;showinfo=0" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
<h2 id="setting-up-the-test-environment">Setting up the test environment</h2>
<p>For test purposes, I&rsquo;ve set up a basic FPS environment using the built-in CharacterController package. I then added a gun model to the _FirstPersonCharacter _game object, which is located as child element in the hierarchy of the <em>FPSController</em>. The following snippet shows the code I added as a custom script component to the gun:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">using</span> UnityEngine;

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">GunScript</span> : MonoBehaviour {

    <span style="color:#66d9ef">public</span> Camera FPSCamera;
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">float</span> maxDistance = <span style="color:#ae81ff">100f</span>;

    <span style="color:#66d9ef">public</span> AudioClip shot;
    <span style="color:#66d9ef">float</span> fireRate = <span style="color:#ae81ff">0.5f</span>;
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">float</span> nextFire = <span style="color:#ae81ff">0.0f</span>;
    <span style="color:#66d9ef">private</span> Transform t;

    <span style="color:#66d9ef">void</span> Start () {
        t = transform;
    }

    <span style="color:#66d9ef">void</span> Update ()
    {
        <span style="color:#66d9ef">if</span>(Input.GetButtonDown(<span style="color:#e6db74">&#34;Fire1&#34;</span>) &amp;&amp; IsOkToShoot())
        {
            Shoot();
        }
    }

    <span style="color:#66d9ef">void</span> Shoot()
    {
        AudioSource.PlayClipAtPoint(shot, t.position);
        RaycastHit rcHit;
        <span style="color:#66d9ef">if</span>(Physics.Raycast(FPSCamera.transform.position, FPSCamera.transform.forward, <span style="color:#66d9ef">out</span> rcHit, maxDistance))
        {
            <span style="color:#66d9ef">if</span>(rcHit.transform.tag == <span style="color:#e6db74">&#34;Enemy&#34;</span>)
            {
                ExplosionScript ex = rcHit.transform.gameObject.GetComponent&lt;ExplosionScript&gt;();
                
                <span style="color:#66d9ef">if</span>(ex != <span style="color:#66d9ef">null</span>)
                {
                    ex.Explode(rcHit.point);
                }
            }
        }
    }

    <span style="color:#66d9ef">bool</span> IsOkToShoot()
    {
        <span style="color:#66d9ef">bool</span> fireable = <span style="color:#66d9ef">false</span>;
        <span style="color:#66d9ef">if</span> (Time.time &gt; nextFire) {
            nextFire = Time.time + fireRate;
            fireable = <span style="color:#66d9ef">true</span>;
        }
        <span style="color:#66d9ef">return</span> fireable;
    }
}<span style="color:#960050;background-color:#1e0010">```</span>

So basically, <span style="color:#66d9ef">this</span> script takes up three <span style="color:#66d9ef">public</span> variables, one <span style="color:#66d9ef">for</span> the camera of the controller, which <span style="color:#66d9ef">is</span> needed to shoot <span style="color:#66d9ef">from</span> the player<span style="color:#960050;background-color:#1e0010">&#39;</span>s perspective, a maxDistance to <span style="color:#66d9ef">set</span> how far can be shot, and an AudioClip to play a sound file when a shot has been fired. Additionally, there are a few <span style="color:#66d9ef">private</span> variables:

  * <span style="color:#ae81ff">_f</span>ireRate,<span style="color:#ae81ff">_</span> to <span style="color:#66d9ef">set</span> how fast shots can be fired after each other
  * <span style="color:#ae81ff">_</span>nextFire_, which <span style="color:#66d9ef">is</span> used to determine when a shot can be fired
  * <span style="color:#ae81ff">_</span>t_, which represents the transform component of the current gameObject

Every frame I check <span style="color:#66d9ef">if</span> the left mouse button <span style="color:#66d9ef">is</span> pressed. If so, a shot should be fired <span style="color:#66d9ef">if</span> the method <span style="color:#ae81ff">_</span>IsOkToShoot()<span style="color:#ae81ff">_</span> returns <span style="color:#ae81ff">_</span>true_. This happens when the current time minus the last time shot <span style="color:#66d9ef">is</span> larger than the previously <span style="color:#66d9ef">set</span> <span style="color:#ae81ff">_f</span>ireRate_.

When an actual shot happens, the sound <span style="color:#66d9ef">is</span> being played <span style="color:#66d9ef">where</span> <span style="color:#ae81ff">_</span>t.position_ determines the location <span style="color:#66d9ef">from</span> <span style="color:#66d9ef">where</span> the shot <span style="color:#66d9ef">is</span> going to be heard. After that, I call up a ray cast to scan the targeted environment <span style="color:#66d9ef">for</span> possible targets. The outgoing argument <span style="color:#ae81ff">_</span>hit_ provides information about the target that has been hit (<span style="color:#66d9ef">if</span> nothing has been hit, the code inside the outermost <span style="color:#66d9ef">if</span>-statement will not be executed).

I created a custom tag called <span style="color:#ae81ff">_</span>Enemy_, which <span style="color:#66d9ef">is</span> going to be added to all the objects I want to hit. These are going to <span style="color:#66d9ef">get</span> a custom script called <span style="color:#ae81ff">_</span>ExplosionScript_, which contains a method named <span style="color:#ae81ff">_</span>Explode_. The next step <span style="color:#66d9ef">is</span> to build <span style="color:#66d9ef">this</span> script and actually blow something up.

<span style="color:#960050;background-color:#1e0010">##</span> Exploding Voxels

I<span style="color:#960050;background-color:#1e0010">&#39;</span>m <span style="color:#66d9ef">using</span> a basic model <span style="color:#66d9ef">for</span> testing purposes, that can bee seen <span style="color:#66d9ef">in</span> the screenshot below.

![Voxel Explosion - Unity Prefab](/assets/<span style="color:#ae81ff">2017</span>/voxel_explosion_1.png)

It currently consists of an empty <span style="color:#ae81ff">_</span>GameObject_ <span style="color:#66d9ef">as</span> parent, which has been expaned <span style="color:#66d9ef">by</span> adding a <span style="color:#ae81ff">_</span>MeshCollider_. The child element contains the actual content.

At first, a <span style="color:#ae81ff">_</span>ParticleSystem_ <span style="color:#66d9ef">is</span> going to be added to the <span style="color:#66d9ef">object</span>. I use the following configuration here:

![Voxel Explosion - Unity Prefab Settings](/assets/<span style="color:#ae81ff">2017</span>/voxel_explosion_2.png)

Note that the last setting (shader) can<span style="color:#960050;background-color:#1e0010">&#39;</span>t be <span style="color:#66d9ef">set</span> yet. That will be created later. Also, <span style="color:#ae81ff">_</span>ExplosionMat_ <span style="color:#66d9ef">is</span> just a regular material. After configuring the <span style="color:#ae81ff">_</span>ParticleSystem_, the animation should look like some cubes exploding and falling <span style="color:#66d9ef">on</span> the ground. Now the colors of the cubes need to be adjusted. The problem <span style="color:#66d9ef">is</span>, that a custom shader and a bit of additional coding <span style="color:#66d9ef">is</span> needed here. Now you just create a <span style="color:#66d9ef">new</span> prefab and move the <span style="color:#ae81ff">_</span>ParticleSystem_ onto it. Then delete it <span style="color:#66d9ef">from</span> the <span style="color:#66d9ef">object</span> that has been used <span style="color:#66d9ef">for</span> testing.

I<span style="color:#960050;background-color:#1e0010">&#39;</span>ll start with the shader. You use the context menu and <span style="color:#66d9ef">add</span> a <span style="color:#66d9ef">new</span> <span style="color:#ae81ff">_</span>shader_ - <span style="color:#ae81ff">_</span>standard surface shader_. You can open the newly created file with Visual Studio (or whatever editor you want) and edit it to match our plan:

<span style="color:#960050;background-color:#1e0010">```</span>csharpShader <span style="color:#e6db74">&#34;Custom/ExplosionShader&#34;</span> {
    Properties {
        <span style="color:#ae81ff">_</span>Color (<span style="color:#e6db74">&#34;Color&#34;</span>, Color) = (<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>)
        <span style="color:#ae81ff">_</span>MainTex (<span style="color:#e6db74">&#34;Albedo (RGB)&#34;</span>, <span style="color:#ae81ff">2D</span>) = <span style="color:#e6db74">&#34;white&#34;</span> {}
        <span style="color:#ae81ff">_</span>Glossiness (<span style="color:#e6db74">&#34;Smoothness&#34;</span>, Range(<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>)) = <span style="color:#ae81ff">0.5</span>
        <span style="color:#ae81ff">_</span>Metallic (<span style="color:#e6db74">&#34;Metallic&#34;</span>, Range(<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>)) = <span style="color:#ae81ff">0.0</span>
    }
    SubShader {
        Tags { <span style="color:#e6db74">&#34;RenderType&#34;</span>=<span style="color:#e6db74">&#34;Opaque&#34;</span> }
        LOD <span style="color:#ae81ff">200</span>
        
        CGPROGRAM
        <span style="color:#75715e">// Physically based Standard lighting model, and enable shadows on all light types
</span><span style="color:#75715e"></span>        <span style="color:#75715e">#pragma surface surf Standard fullforwardshadows
</span><span style="color:#75715e"></span>
        <span style="color:#75715e">// Use shader model 3.0 target, to get nicer looking lighting
</span><span style="color:#75715e"></span>        <span style="color:#75715e">#pragma target 3.0
</span><span style="color:#75715e"></span>
        sampler2D <span style="color:#ae81ff">_</span>MainTex;

        <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Input</span> {
            float2 uv_MainTex;
            
            <span style="color:#75715e">// NEW LINE
</span><span style="color:#75715e"></span>            float4 vertexColor : COLOR;
        };

        half <span style="color:#ae81ff">_</span>Glossiness;
        half <span style="color:#ae81ff">_</span>Metallic;
        fixed4 <span style="color:#ae81ff">_</span>Color;

        <span style="color:#66d9ef">void</span> surf (Input IN, inout SurfaceOutputStandard o) {
            <span style="color:#75715e">// Albedo comes from a texture tinted by color
</span><span style="color:#75715e"></span>            fixed4 c = tex2D (<span style="color:#ae81ff">_</span>MainTex, IN.uv_MainTex) * <span style="color:#ae81ff">_</span>Color;
            
            <span style="color:#75715e">// NEW LINE:
</span><span style="color:#75715e"></span>            c *= IN.vertexColor;


            o.Albedo = c.rgb;
            <span style="color:#75715e">// Metallic and smoothness come from slider variables
</span><span style="color:#75715e"></span>            o.Metallic = <span style="color:#ae81ff">_</span>Metallic;
            o.Smoothness = <span style="color:#ae81ff">_</span>Glossiness;
            o.Alpha = c.a;
        }
        ENDCG
    }
    FallBack <span style="color:#e6db74">&#34;Diffuse&#34;</span>
}<span style="color:#960050;background-color:#1e0010">```</span>

There are two lines that need to be adjusted, I<span style="color:#960050;background-color:#1e0010">&#39;</span>ve marked them with the comment <span style="color:#ae81ff">_</span><span style="color:#75715e">//NEW LINE_. After that, the currently used material for the particles should be set to the color white. The color that is going to be set later will be mixed with the default color, and if that isn&#39;t white the colors won&#39;t match our wanted ones. Also, the shader of the material needs to be set to the newly created one.
</span><span style="color:#75715e"></span>
An additional script <span style="color:#66d9ef">is</span> needed to edit the palette.

<span style="color:#960050;background-color:#1e0010">```</span>csharpusing UnityEngine;

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ExplosionScript</span> : MonoBehaviour {

    <span style="color:#66d9ef">public</span> GameObject explosionPrefab;
    <span style="color:#66d9ef">private</span> GameObject explosion;
    <span style="color:#66d9ef">bool</span> exploding = <span style="color:#66d9ef">false</span>;

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span> colorDescriptor;
    <span style="color:#66d9ef">private</span> Color32[] colors;

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Explode(Vector3 pos)
    {
        explosion = Instantiate(explosionPrefab, pos, Quaternion.Euler(<span style="color:#ae81ff">0f</span>,<span style="color:#ae81ff">0f</span>,<span style="color:#ae81ff">0f</span>));
        exploding = <span style="color:#66d9ef">true</span>;       
    }

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> LateUpdate()
    {
        <span style="color:#66d9ef">if</span>(exploding)
        {
            ParticleSystem explosionParticleSystem = explosion.GetComponent&lt;ParticleSystem&gt;();
            ParticleSystem.Particle[] particles = <span style="color:#66d9ef">new</span> ParticleSystem.Particle[explosionParticleSystem.main.maxParticles];
            colors = ColorManager.getColor(colorDescriptor);
            <span style="color:#66d9ef">int</span> numParticlesAlive = explosionParticleSystem.GetParticles(particles);
            <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i = <span style="color:#ae81ff">0</span>; i &lt; numParticlesAlive; i++)
            {
                particles[i].startColor = colors[Random.Range(<span style="color:#ae81ff">0</span>, colors.Length)];
            }
            explosionParticleSystem.SetParticles(particles, numParticlesAlive);
            exploding = <span style="color:#66d9ef">false</span>;

            Destroy(gameObject);
        }       
    }
}<span style="color:#960050;background-color:#1e0010">```</span>

Again, here are some <span style="color:#66d9ef">public</span> and <span style="color:#66d9ef">private</span> variables:

  * <span style="color:#ae81ff">_</span>explosionPrefab_ represents the prefab containing the ParticleSystem
  * <span style="color:#ae81ff">_</span>explosion_ <span style="color:#66d9ef">is</span> an instance of the prefab
  * <span style="color:#ae81ff">_</span>exploding_ <span style="color:#66d9ef">is</span> a flag <span style="color:#66d9ef">for</span> controlling the explosion
  * <span style="color:#ae81ff">_</span>colors_ <span style="color:#66d9ef">is</span> an array containing the colors that are going to be assigned to the exploding particles

The first method starts the explosion. It instantiates the explosion at a given position, which <span style="color:#66d9ef">is</span> going to be <span style="color:#66d9ef">where</span> the ray cast hit the <span style="color:#66d9ef">object</span>. In <span style="color:#ae81ff">_L</span>ateUpdate()<span style="color:#ae81ff">_</span>, the particles are going to be painted. This method <span style="color:#66d9ef">is</span> only run, when the exploding-flag <span style="color:#66d9ef">is</span> <span style="color:#66d9ef">set</span> to <span style="color:#ae81ff">_</span>true_, and it <span style="color:#66d9ef">is</span> also run only once, which <span style="color:#66d9ef">is</span> why the flag <span style="color:#66d9ef">is</span> <span style="color:#66d9ef">set</span> to <span style="color:#ae81ff">_f</span>alse_ again at the end.

The <span style="color:#ae81ff">_</span>gameObject_ itself <span style="color:#66d9ef">is</span> destroyed <span style="color:#66d9ef">in</span> the very end, since it <span style="color:#66d9ef">is</span> needed to assign its properties to the <span style="color:#ae81ff">_</span>ParticleSystem_ created at runtime.

All the particles of the explosion are collected inside the <span style="color:#ae81ff">_</span>particles <span style="color:#ae81ff">_</span>array. The <span style="color:#66d9ef">for</span>-loop <span style="color:#66d9ef">is</span> iterating through all of the particles and assigns a <span style="color:#66d9ef">new</span> color. The color <span style="color:#66d9ef">is</span> determined via random selection of a color of the above-mentioned array. I found <span style="color:#66d9ef">this</span> solution to be a bit ugly, so I created another script called <span style="color:#ae81ff">_</span>ColorManager_, which contains arrays <span style="color:#66d9ef">for</span> each of my models. It basically just contains the following code:

<span style="color:#960050;background-color:#1e0010">```</span>csharpprivate <span style="color:#66d9ef">static</span> Color32[] foxColors =
{
    <span style="color:#66d9ef">new</span> Color32(<span style="color:#ae81ff">238</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">255</span>),
    <span style="color:#66d9ef">new</span> Color32(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">34</span>, <span style="color:#ae81ff">255</span>),
    <span style="color:#66d9ef">new</span> Color32(<span style="color:#ae81ff">238</span>,<span style="color:#ae81ff">238</span>,<span style="color:#ae81ff">238</span>,<span style="color:#ae81ff">255</span>),
    <span style="color:#66d9ef">new</span> Color32(<span style="color:#ae81ff">187</span>,<span style="color:#ae81ff">187</span>,<span style="color:#ae81ff">187</span>,<span style="color:#ae81ff">255</span>)
};

<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> Color32[] chickenColors =
{
    <span style="color:#66d9ef">new</span> Color32(<span style="color:#ae81ff">238</span>,<span style="color:#ae81ff">238</span>,<span style="color:#ae81ff">238</span>,<span style="color:#ae81ff">255</span>),
    <span style="color:#66d9ef">new</span> Color32(<span style="color:#ae81ff">238</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">255</span>),
    <span style="color:#66d9ef">new</span> Color32(<span style="color:#ae81ff">255</span>,<span style="color:#ae81ff">102</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">255</span>),
    <span style="color:#66d9ef">new</span> Color32(<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">17</span>,<span style="color:#ae81ff">255</span>)
};

<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> Color32[] emptyColors =
{
    <span style="color:#66d9ef">new</span> Color32(<span style="color:#ae81ff">255</span>,<span style="color:#ae81ff">255</span>,<span style="color:#ae81ff">255</span>,<span style="color:#ae81ff">255</span>)
};

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> Color32[] getColor(<span style="color:#66d9ef">string</span> colorDescription)
{
    <span style="color:#66d9ef">switch</span>(colorDescription)
    {
        <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;fox&#34;</span>:
            <span style="color:#66d9ef">return</span> foxColors;
        <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;chicken&#34;</span>:
            <span style="color:#66d9ef">return</span> chickenColors;
        <span style="color:#66d9ef">default</span>:
            <span style="color:#66d9ef">return</span> emptyColors;
    }
}<span style="color:#960050;background-color:#1e0010">```</span>

&amp;nbsp;

Note that you can view the colors that have been used <span style="color:#66d9ef">using</span> MagicaVoxel <span style="color:#66d9ef">by</span> clicking <span style="color:#66d9ef">on</span> the tool marked <span style="color:#66d9ef">by</span> a <span style="color:#ae81ff">_</span>smaller-than sign_ and then clicking <span style="color:#66d9ef">on</span> <span style="color:#ae81ff">_</span>HSV_.

![Voxel Explosion - MagicaVoxel Color Palette](/assets/<span style="color:#ae81ff">2017</span>/voxel_explosion_3.png)

If <span style="color:#66d9ef">this</span> <span style="color:#66d9ef">is</span> done, the explosions should work!</code></pre></div>
</div>


    </main>

    
      
    
  </body>
</html>
