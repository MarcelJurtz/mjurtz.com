<p>In my <a href="http://blog.mjurtz.com/2017/09/creating-restful-services-servicestack/">last post</a>, I’ve set up a basic RESTful service using ServiceStack. This article deals with the implementation of a corresponding functionality on the client side. The application will query the path provided by the server and apply the pre-defined authentication method, requiring the user to log in with username and password before the application delivers the desired content.</p>

<p>Both projects, client and server are located on my <a href="https://github.com/MarcelJurtz/ServiceStackExamples">GitHub-profile</a> and can be viewed and downloaded there.</p>

<p>The structure of the client is very simple. There are two textboxes for entering username and password, as well as one for entering a name for the <em>hello/{name*}</em> path. The button sends the request and the richtextbox is filled with the response.</p>

<p><img src="/assets/2017/servicestack-client-demo.png" alt="ServiceStack Client Demo Application" /></p>

<p>Access to the classes created for the server-side service is required. For this reason, these were also added to the project. This includes <em>Hello</em> and <em>HelloResponse</em>.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="na">[Route("/hello/{name*}")]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">Hello</span> <span class="p">:</span> <span class="n">IReturn</span><span class="p">&lt;</span><span class="n">HelloResponse</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">HelloResponse</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">Result</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>The same applies to the custom AuthenticationProvider.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">public</span> <span class="k">class</span> <span class="nc">CustomAuthenticationProvider</span> <span class="p">:</span> <span class="n">CredentialsAuthProvider</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">override</span> <span class="kt">bool</span> <span class="nf">TryAuthenticate</span><span class="p">(</span><span class="n">IServiceBase</span> <span class="n">authService</span><span class="p">,</span> <span class="kt">string</span> <span class="n">userName</span><span class="p">,</span> <span class="kt">string</span> <span class="n">password</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// Only checks if username equals password
</span>
        <span class="c1">// implement custom logic here
</span>
        <span class="k">return</span> <span class="n">userName</span><span class="p">.</span><span class="nf">Equals</span><span class="p">(</span><span class="n">password</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="k">override</span> <span class="n">IHttpResult</span> <span class="nf">OnAuthenticated</span><span class="p">(</span><span class="n">IServiceBase</span> <span class="n">authService</span><span class="p">,</span> <span class="n">IAuthSession</span> <span class="n">session</span><span class="p">,</span> <span class="n">IAuthTokens</span> <span class="n">tokens</span><span class="p">,</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;</span> <span class="n">authInfo</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//session.customElement = "Hello World";
</span>
        <span class="k">return</span> <span class="k">base</span><span class="p">.</span><span class="nf">OnAuthenticated</span><span class="p">(</span><span class="n">authService</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">tokens</span><span class="p">,</span> <span class="n">authInfo</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>An additional class has been created to control access to the service. This encapsulates the requests, which can be easily accessed from outside.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">ServiceStack</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">RESTfulDemoClient</span>
<span class="p">{</span>
    <span class="k">class</span> <span class="nc">RESTfulServiceClient</span> <span class="p">:</span> <span class="n">IDisposable</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">const</span> <span class="n">String</span> <span class="n">url</span> <span class="p">=</span> <span class="s">"http://localhost:64424"</span><span class="p">;</span>
        <span class="k">private</span> <span class="n">JsonServiceClient</span> <span class="n">serviceclient</span><span class="p">;</span>

        <span class="k">private</span> <span class="n">JsonServiceClient</span> <span class="nf">getServiceClient</span><span class="p">(</span><span class="n">String</span> <span class="n">usern</span><span class="p">,</span> <span class="n">String</span> <span class="n">passw</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="n">serviceclient</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">serviceclient</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">JsonServiceClient</span><span class="p">(</span><span class="n">url</span><span class="p">);</span>

                <span class="kt">var</span> <span class="n">authResponse</span> <span class="p">=</span> <span class="n">serviceclient</span><span class="p">.</span><span class="nf">Post</span><span class="p">(</span><span class="k">new</span> <span class="n">Authenticate</span>
                <span class="p">{</span>
                    <span class="n">provider</span> <span class="p">=</span> <span class="n">CustomAuthenticationProvider</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="c1">//= credentials
</span>
                    <span class="n">UserName</span> <span class="p">=</span> <span class="n">usern</span><span class="p">,</span>
                    <span class="n">Password</span> <span class="p">=</span> <span class="n">passw</span><span class="p">,</span>
                    <span class="n">RememberMe</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span>
                <span class="p">});</span>

                <span class="n">serviceclient</span><span class="p">.</span><span class="n">AlwaysSendBasicAuthHeader</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="n">serviceclient</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="n">HelloResponse</span> <span class="nf">GetHelloResponse</span><span class="p">(</span><span class="n">Hello</span> <span class="n">request</span><span class="p">,</span> <span class="n">String</span> <span class="n">username</span><span class="p">,</span> <span class="n">String</span> <span class="n">password</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">client</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="nf">getServiceClient</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">);</span>
            <span class="kt">var</span> <span class="n">response</span> <span class="p">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">Post</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">response</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">Dispose</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">serviceclient</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>The class already contains all the logic required for access control, and the method <em>GetHelloResponse</em> can be used to retrieve a response from the <em>Hello</em>-path, which is implemented like this:</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">using</span><span class="p">(</span><span class="kt">var</span> <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">RESTfulServiceClient</span><span class="p">())</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">request</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Hello</span><span class="p">()</span> <span class="p">{</span> <span class="n">Name</span> <span class="p">=</span> <span class="n">txtRequest</span><span class="p">.</span><span class="n">Text</span> <span class="p">};</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">response</span> <span class="p">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">GetHelloResponse</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">txtUsername</span><span class="p">.</span><span class="n">Text</span><span class="p">,</span> <span class="n">txtPassword</span><span class="p">.</span><span class="n">Text</span><span class="p">);</span>
        <span class="n">txtResponse</span><span class="p">.</span><span class="n">Text</span> <span class="p">=</span> <span class="n">response</span><span class="p">.</span><span class="n">Result</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="n">ServiceStack</span><span class="p">.</span><span class="n">WebServiceException</span> <span class="n">ex</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">txtResponse</span><span class="p">.</span><span class="n">Text</span> <span class="p">=</span> <span class="n">ex</span><span class="p">.</span><span class="n">StatusCode</span> <span class="p">+</span> <span class="s">" - "</span> <span class="p">+</span> <span class="n">ex</span><span class="p">.</span><span class="n">ErrorMessage</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>
