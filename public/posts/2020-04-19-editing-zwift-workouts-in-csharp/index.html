<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.88.1" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Editing Zwift Workouts in C# &middot; Marcel Jurtz</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://www.mjurtz.com/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://www.mjurtz.com/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://www.mjurtz.com/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://www.mjurtz.com/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  
</head>

  <body class=" ">
  <aside class="sidebar">
    <div class="container sidebar-sticky">
        <div class="sidebar-about">
            <a href="https://www.mjurtz.com/">
                <h1>Marcel Jurtz</h1>
            </a>
            <p class="lead">
                 Notes and thoughts on software development 
            </p>
        </div>

        <nav>
            <ul class="sidebar-nav">
                <li><a href="https://www.mjurtz.com/">Home</a> </li>
                <li><a href="/about/"> About </a></li><li><a href="/imprint/"> Imprint / Impressum </a></li><li><a href="/privacy/"> Privacy / Datenschutz </a></li>
            </ul>
        </nav>

    </div>
</aside>
    <main class="content container">
    <div class="post">
  <h1>Editing Zwift Workouts in C#</h1>
  <time datetime=2020-04-19T06:00:00Z class="post-date">Sun, Apr 19, 2020</time>
  <p>I&rsquo;ve been using <a href="https://zwift.com/eu-de">Zwift</a> pretty extensively for the last few months. For anyone unfamiliar: Zwift is a VR Biking platform. That means, you can put your bike on a smarttrainer, connect it to your pc (directly via ant+ / ble or by bridging with your phone), and then you can ride virtual worlds without having to go outside. Sounds not too bad, right?</p>
<p>After a few sessions, just riding became kind of tedious, so I&rsquo;ve tried to do some of the preconfigured workouts. You can either do workouts by themselves or follow a trainingplan, which consists of multiple workouts that you have to complete to a given date. The workouts all have the same structure. They consist of different blocks, that can have a variety of requirements. The blocks that are available are either steady pedaling, ramps (up or down) or intervals (alternating steady blocks of high and low power which are repeated to a predetermined extent). Basically, there are some more types, but we&rsquo;ll get back to that later. Let&rsquo;s take a look at one of these workouts for example.</p>
<p><img src="/assets/2020/wringer_workout.png" alt="Built-In Workout - The Wringer"></p>
<p>My main resource for zwift workouts is <a href="https://whatsonzwift.com/">WhatsOnZwift</a>. You can view the built-in plans and workouts there and also browse custom workouts. You can download and import the custom workouts also, but sadly, you can&rsquo;t download the built-in ones. Sadly because I&rsquo;d like to use the original files for some reverse-engineering. But let&rsquo;s go with what&rsquo;s available. The following example is a custom workout I created myself, but you can just download any of the custom workouts from WhatsOnZwift to play around with. After downloading the workout, you&rsquo;ll get a .zwo-file, which can be opened with an editor of your choice. And, as expected, the file is just plain xml:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;workout_file&gt;</span>
    <span style="color:#f92672">&lt;author&gt;</span>Marcel Jurtz<span style="color:#f92672">&lt;/author&gt;</span>
    <span style="color:#f92672">&lt;name&gt;</span>ZWO File Demo<span style="color:#f92672">&lt;/name&gt;</span>
    <span style="color:#f92672">&lt;description&gt;</span>A zwo file demo. No real workout, probably don&#39;t try to ride this.<span style="color:#f92672">&lt;/description&gt;</span>
    <span style="color:#f92672">&lt;sportType&gt;</span>bike<span style="color:#f92672">&lt;/sportType&gt;</span>
    <span style="color:#f92672">&lt;tags&gt;</span>
        <span style="color:#f92672">&lt;tag</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;Test&#34;</span><span style="color:#f92672">/&gt;</span>
        <span style="color:#f92672">&lt;tag</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;Demo&#34;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;/tags&gt;</span>
    <span style="color:#f92672">&lt;workout&gt;</span>
        <span style="color:#f92672">&lt;Ramp</span> <span style="color:#a6e22e">Duration=</span><span style="color:#e6db74">&#34;300&#34;</span> <span style="color:#a6e22e">PowerLow=</span><span style="color:#e6db74">&#34;0.25&#34;</span> <span style="color:#a6e22e">PowerHigh=</span><span style="color:#e6db74">&#34;0.75&#34;</span> <span style="color:#f92672">/&gt;</span>
        <span style="color:#f92672">&lt;IntervalsT</span> <span style="color:#a6e22e">Repeat=</span><span style="color:#e6db74">&#34;10&#34;</span> <span style="color:#a6e22e">OnDuration=</span><span style="color:#e6db74">&#34;30&#34;</span> <span style="color:#a6e22e">OffDuration=</span><span style="color:#e6db74">&#34;30&#34;</span> <span style="color:#a6e22e">OnPower=</span><span style="color:#e6db74">&#34;1.3&#34;</span> <span style="color:#a6e22e">OffPower=</span><span style="color:#e6db74">&#34;0.5&#34;</span> <span style="color:#f92672">/&gt;</span>
        <span style="color:#f92672">&lt;SteadyState</span> <span style="color:#a6e22e">Duration=</span><span style="color:#e6db74">&#34;180&#34;</span> <span style="color:#a6e22e">Power=</span><span style="color:#e6db74">&#34;0.5&#34;</span> <span style="color:#f92672">/&gt;</span>
        <span style="color:#f92672">&lt;IntervalsT</span> <span style="color:#a6e22e">Repeat=</span><span style="color:#e6db74">&#34;10&#34;</span> <span style="color:#a6e22e">OnDuration=</span><span style="color:#e6db74">&#34;30&#34;</span> <span style="color:#a6e22e">OffDuration=</span><span style="color:#e6db74">&#34;30&#34;</span> <span style="color:#a6e22e">OnPower=</span><span style="color:#e6db74">&#34;1.3&#34;</span> <span style="color:#a6e22e">OffPower=</span><span style="color:#e6db74">&#34;0.5&#34;</span> <span style="color:#f92672">/&gt;</span>
        <span style="color:#f92672">&lt;SteadyState</span> <span style="color:#a6e22e">Duration=</span><span style="color:#e6db74">&#34;180&#34;</span> <span style="color:#a6e22e">Power=</span><span style="color:#e6db74">&#34;0.5&#34;</span> <span style="color:#f92672">/&gt;</span>
        <span style="color:#f92672">&lt;Cooldown</span> <span style="color:#a6e22e">Duration=</span><span style="color:#e6db74">&#34;480&#34;</span> <span style="color:#a6e22e">PowerLow=</span><span style="color:#e6db74">&#34;0.5&#34;</span> <span style="color:#a6e22e">PowerHigh=</span><span style="color:#e6db74">&#34;0.75&#34;</span> <span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;/workout&gt;</span>
<span style="color:#f92672">&lt;/workout_file&gt;</span>
</code></pre></div><p>As you can see, the file itself consists of two parts: A step-by-step description of the workout itself, and some additional metadata. The metadata contains information like the author of the workout, along with its name and description. Since Zwift currently supports both biking and treadmill running, there&rsquo;s an additional element specifying the type of sport the workout is targeting. You can also add tags to the workout for increased searchability.</p>
<p>Now let&rsquo;s jump into the more interesting part. The workout consists of a Warmup, which is basically a ramp from 25% to 75% of your FTP. Note that all performance values are based on a percentage of your individual FTP. This warmup takes 300 seconds, so 5 minutes. The warm-up is followed by two interval sessions, which are interrupted by a short 3-minute break to get your heartrate back down. Each of the interval session consist of 10 repeats of 30 seconds at 130%, followed by 30 seconds at 50% FTP. After completing both sessions, there&rsquo;s an additional 3 minutes of easy pedaling at 50% before beginning the cooldown. The cooldown again as a reverse-ramp, lowering the power from 75% to 50% over a period of 8 minutes.</p>
<p>So, nothing too complicated, right? I&rsquo;ve been checking out some workouts and noticed that there&rsquo;s a bit more variety to take care of. However, zwift doesn&rsquo;t seem to publish any kind of developers guide to check out the details. On the other hand, I found <a href="https://github.com/h4l/zwift-workout-file-reference">this unofficial guide</a> on GitHub. So, as long as it works, I&rsquo;ll stick to that.</p>
<p>The first big chuck of information I&rsquo;m interested in are the different types of workouts and how they are different from each other. There are additional types such as FreeRide, MaxEffort or Ramp (which looks very similar to a warmup) and each of those uses different parameters to describe the session. For example, freerides don&rsquo;t offer a way to set a power output, which makes total sense.</p>
<p>All of the workouts can contain sub-elements called <em>textevent</em>. If you&rsquo;ve been doing some of the beginner plans on zwift, you might have seen those. They basically show up in the middle of the workout, printing some text on the screen which is usually either motivational gibberish or information on what to focus on during the workout. They are defined by adding a text and a duration on how long the text should be visible. To define the time the text will appear, I&rsquo;ve only seen timed offsets so far. However, the guide says there&rsquo;s also an option to specify the time based on distance.</p>
<p>I could dive in the guides details probably forever, but for now, let&rsquo;s just try to build an app that can read and write the workout I&rsquo;ve added above. With a basic implementation, more workout types and parameters can then be added more easily.</p>
<p>So, to start we need to create a data structure that matches the given xml. Don&rsquo;t worry too much about the naming here because the matching will be done with attributes later. Also, it&rsquo;s a good practice to be more consistent in the naming than Zwift. I came up with the following classes:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">WorkoutFile</span>
{
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span> Author { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span> Name { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span> Description { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
    <span style="color:#66d9ef">public</span> SportsType SportType { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
    <span style="color:#66d9ef">public</span> List&lt;Tag&gt; Tags { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
    <span style="color:#66d9ef">public</span> List&lt;WorkoutItem&gt; Workouts { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
}

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">WorkoutItem</span>
{
    
}

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">enum</span> SportsType
{
    none,
    bike,
    run
}

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SteadyState</span> : WorkoutItem
{
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> Duration { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">double</span> Power { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
}

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Interval</span> : WorkoutItem
{
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> Repeat { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> OnDuration { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> OffDuration { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">double</span> OnPower { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">double</span> OffPower { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
}

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Ramp</span> : WorkoutItem
{
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> Duration { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">double</span> PowerLow { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">double</span> PowerHigh { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
}

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Cooldown</span> : WorkoutItem
{
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> Duration { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">double</span> PowerLow { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">double</span> PowerHigh { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
}

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Tag</span>
{
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span> Name { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
}
</code></pre></div><p>That&rsquo;s it for now. With this state, I can now describe the workout from the xml file, but the automatic mapping is not working just yet. Let&rsquo;s now add the attributes for the name matching. Note that I added an enumeration for the sportsType-property. This doesn&rsquo;t need any additional handling tough, the (de-)serialization automatically picks the matching string representation.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#a6e22e">[XmlType(&#34;workout_file&#34;)]</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">WorkoutFile</span>
{
<span style="color:#a6e22e">    [XmlElement(&#34;author&#34;)]</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span> Author { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
<span style="color:#a6e22e">
</span><span style="color:#a6e22e">    [XmlElement(&#34;name&#34;)]</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span> Name { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
<span style="color:#a6e22e">
</span><span style="color:#a6e22e">    [XmlElement(&#34;description&#34;)]</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span> Description { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
<span style="color:#a6e22e">
</span><span style="color:#a6e22e">    [XmlElement(&#34;sportType&#34;)]</span>
    <span style="color:#66d9ef">public</span> SportsType SportType { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
<span style="color:#a6e22e">
</span><span style="color:#a6e22e">    [XmlArray(&#34;tags&#34;)]</span>
    <span style="color:#66d9ef">public</span> List&lt;Tag&gt; Tags { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
<span style="color:#a6e22e">
</span><span style="color:#a6e22e">    [XmlArray(&#34;workout&#34;)]</span>
    <span style="color:#66d9ef">public</span> List&lt;WorkoutItem&gt; Workouts { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
}

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">WorkoutItem</span>
{
    
}

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">enum</span> SportsType
{
    none,
    bike,
    run
}
<span style="color:#a6e22e">
</span><span style="color:#a6e22e">[XmlRoot(&#34;SteadyState&#34;)]</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SteadyState</span> : WorkoutItem
{
<span style="color:#a6e22e">    [XmlAttribute(&#34;Duration&#34;)]</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> Duration { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
<span style="color:#a6e22e">    [XmlAttribute(&#34;Power&#34;)]</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">double</span> Power { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
}
<span style="color:#a6e22e">
</span><span style="color:#a6e22e">[XmlRoot(&#34;IntervalsT&#34;)]</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Interval</span> : WorkoutItem
{
<span style="color:#a6e22e">    [XmlAttribute(&#34;Repeat&#34;)]</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> Repeat { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
<span style="color:#a6e22e">    [XmlAttribute(&#34;OnDuration&#34;)]</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> OnDuration { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
<span style="color:#a6e22e">    [XmlAttribute(&#34;OffDuration&#34;)]</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> OffDuration { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
<span style="color:#a6e22e">    [XmlAttribute(&#34;OnPower&#34;)]</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">double</span> OnPower { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
<span style="color:#a6e22e">    [XmlAttribute(&#34;OffPower&#34;)]</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">double</span> OffPower { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
}
<span style="color:#a6e22e">
</span><span style="color:#a6e22e">[XmlRoot(&#34;Ramp&#34;)]</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Ramp</span> : WorkoutItem
{
<span style="color:#a6e22e">    [XmlAttribute(&#34;Duration&#34;)]</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> Duration { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
<span style="color:#a6e22e">    [XmlAttribute(&#34;PowerLow&#34;)]</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">double</span> PowerLow { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
<span style="color:#a6e22e">    [XmlAttribute(&#34;PowerHigh&#34;)]</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">double</span> PowerHigh { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
}
<span style="color:#a6e22e">
</span><span style="color:#a6e22e">[XmlRoot(&#34;Cooldown&#34;)]</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Cooldown</span> : WorkoutItem
{
<span style="color:#a6e22e">    [XmlAttribute(&#34;Duration&#34;)]</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> Duration { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
<span style="color:#a6e22e">    [XmlAttribute(&#34;PowerLow&#34;)]</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">double</span> PowerLow { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
<span style="color:#a6e22e">    [XmlAttribute(&#34;PowerHigh&#34;)]</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">double</span> PowerHigh { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
}
<span style="color:#a6e22e">
</span><span style="color:#a6e22e">[XmlRoot(&#34;tag&#34;)]</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Tag</span>
{
<span style="color:#a6e22e">    [XmlAttribute(&#34;name&#34;)]</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span> Name { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
}
</code></pre></div><p>Note that I used different attributes for different purposes. Each class is decorated with an <em>XmlRoot</em>-attribute, while each property uses an <em>XmlElement</em>-attribute. At least for the WorkoutFile-class. That&rsquo;s the default behaviour, but it doesn&rsquo;t work for the workouts themselves. If I would use XmlElements for these too, I&rsquo;d end up with sub-nodes for these too.</p>
<p>That&rsquo;s how a workout would look like with XmlElements as Items:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;Ramp&gt;</span>
  <span style="color:#f92672">&lt;Duration&gt;</span>300<span style="color:#f92672">&lt;/Duration&gt;</span>
  <span style="color:#f92672">&lt;PowerLow&gt;</span>0.25<span style="color:#f92672">&lt;/PowerLow&gt;</span>
  <span style="color:#f92672">&lt;PowerHigh&gt;</span>0.75<span style="color:#f92672">&lt;/PowerHigh&gt;</span>
<span style="color:#f92672">&lt;/Ramp&gt;</span>
</code></pre></div><p>But since this is what we want, we&rsquo;ll have to use XmlAttributes instead:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;Ramp</span> <span style="color:#a6e22e">Duration=</span><span style="color:#e6db74">&#34;300&#34;</span> <span style="color:#a6e22e">PowerLow=</span><span style="color:#e6db74">&#34;0.25&#34;</span> <span style="color:#a6e22e">PowerHigh=</span><span style="color:#e6db74">&#34;0.75&#34;</span> <span style="color:#f92672">/&gt;</span>
</code></pre></div><p>The xml matching is almost working at this point. The last step now is to define the collection properties. Zwift uses Tags for each concrete workout type, so we can&rsquo;t go with something like</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;workout</span> <span style="color:#a6e22e">i:type=</span><span style="color:#e6db74">&#34;Cooldown&#34;</span><span style="color:#f92672">&gt;</span>
</code></pre></div><p>To achieve this, all I need to do is adjust both collections as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#a6e22e">[XmlArray(&#34;tags&#34;)]</span>
<span style="color:#a6e22e">[XmlArrayItem(&#34;tag&#34;, Type = typeof(Tag))]</span>
<span style="color:#66d9ef">public</span> List&lt;Tag&gt; Tags { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
<span style="color:#a6e22e">
</span><span style="color:#a6e22e">[XmlArray(&#34;workout&#34;)]</span>
<span style="color:#a6e22e">[XmlArrayItem(&#34;SteadyState&#34;, Type = typeof(SteadyState))]</span>
<span style="color:#a6e22e">[XmlArrayItem(&#34;IntervalsT&#34;, Type = typeof(Interval))]</span>
<span style="color:#a6e22e">[XmlArrayItem(&#34;Ramp&#34;, Type = typeof(Ramp))]</span>
<span style="color:#a6e22e">[XmlArrayItem(&#34;Cooldown&#34;, Type = typeof(Cooldown))]</span>
<span style="color:#66d9ef">public</span> List&lt;WorkoutItem&gt; Workouts { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
</code></pre></div><p>And that&rsquo;s basically it! To test the functionality, I created a new console application and added methods to both read and write a workout file.
Let&rsquo;s focus on reading for now:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> Main(<span style="color:#66d9ef">string</span>[] args)
{
  <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">string</span> fileName =  <span style="color:#e6db74">@&#34;C:\Users\marcel\documents\demo.zwo&#34;</span>;

  <span style="color:#66d9ef">if</span> (!File.Exists(fileName))
  {
      Console.WriteLine(<span style="color:#e6db74">&#34;File not found&#34;</span>);
  }
  <span style="color:#66d9ef">else</span>
  {
      <span style="color:#66d9ef">var</span> workout = Deserialize(fileName);
  }

  Console.WriteLine(<span style="color:#e6db74">&#34;Press any key to exit&#34;</span>);
}

<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> WorkoutFile Deserialize(<span style="color:#66d9ef">string</span> filename)
{
  XmlSerializer deserializer = <span style="color:#66d9ef">new</span> XmlSerializer(<span style="color:#66d9ef">typeof</span>(WorkoutFile), <span style="color:#66d9ef">new</span> Type[] { <span style="color:#66d9ef">typeof</span>(SteadyState), <span style="color:#66d9ef">typeof</span>(Interval), <span style="color:#66d9ef">typeof</span>(Ramp), <span style="color:#66d9ef">typeof</span>(Cooldown), <span style="color:#66d9ef">typeof</span>(Tag) });

    <span style="color:#66d9ef">using</span> (Stream stream = File.OpenRead(fileName))
    {
        <span style="color:#66d9ef">return</span> (WorkoutFile)deserializer.Deserialize(stream);
    }
}
</code></pre></div><p>Note that you need to specify the types that the object will be serialized to. This includes nested types, so I set <em>WorkoutFile</em> as first argument and an array including all of the workout types and <em>Tag</em> as the second one. When running the application now, the file gets deserialized and I get an object representing the workout. Seems to work well so far!</p>
<p>Now, to the deserialization part. This worked out to be a bit trickier than the deserialization, because there&rsquo;s a lot of metadata automatically being added to the xml file. However, since I don&rsquo;t have control over the schema, I&rsquo;ll have to get rid of all that. Here&rsquo;s how I achieved that: First I recreated the workout by code, so I&rsquo;d be able to compare both files side-by-side.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">var</span> workout = <span style="color:#66d9ef">new</span> WorkoutFile()
{
    Author = <span style="color:#e6db74">&#34;Marcel Jurtz&#34;</span>,
    Description = <span style="color:#e6db74">&#34;ZWO File Demo&#34;</span>,
    Name = <span style="color:#e6db74">&#34;A zwo file demo. No real workout, probably don&#39;t try to ride this.&#34;</span>,
    SportType = SportsType.bike,
    Tags = <span style="color:#66d9ef">new</span> List&lt;Tag&gt;() 
    { 
        <span style="color:#66d9ef">new</span> Tag() { Name = <span style="color:#e6db74">&#34;Test&#34;</span> },
        <span style="color:#66d9ef">new</span> Tag() { Name = <span style="color:#e6db74">&#34;Demo&#34;</span> }
    },
    Workouts = <span style="color:#66d9ef">new</span> List&lt;WorkoutItem&gt;()
    {
        <span style="color:#66d9ef">new</span> Ramp() { Duration = <span style="color:#ae81ff">300</span>, PowerLow = <span style="color:#ae81ff">0.25</span>, PowerHigh = <span style="color:#ae81ff">0.75</span> },
        <span style="color:#66d9ef">new</span> Interval() { Repeat = <span style="color:#ae81ff">10</span>, OnDuration = <span style="color:#ae81ff">30</span>, OffDuration = <span style="color:#ae81ff">30</span>, OnPower = <span style="color:#ae81ff">1.3</span>, OffPower = <span style="color:#ae81ff">0.5</span> },
        <span style="color:#66d9ef">new</span> SteadyState() { Duration = <span style="color:#ae81ff">180</span>, Power = <span style="color:#ae81ff">0.5</span> },
        <span style="color:#66d9ef">new</span> Interval() { Repeat = <span style="color:#ae81ff">10</span>, OnDuration = <span style="color:#ae81ff">30</span>, OffDuration = <span style="color:#ae81ff">30</span>, OnPower = <span style="color:#ae81ff">1.3</span>, OffPower = <span style="color:#ae81ff">0.5</span> },
        <span style="color:#66d9ef">new</span> SteadyState() { Duration = <span style="color:#ae81ff">180</span>, Power = <span style="color:#ae81ff">0.5</span> },
        <span style="color:#66d9ef">new</span> Cooldown() { Duration = <span style="color:#ae81ff">480</span>, PowerLow = <span style="color:#ae81ff">0.5</span>, PowerHigh = <span style="color:#ae81ff">0.75</span> }
    }
};
</code></pre></div><p>To serialize this, I added the following method to my program. As I mentioned, I had to remove the xml metadata from the output file, so I added some custom XmlWriterSettings. Additionally, I&rsquo;ve added an empty string to the XmlSerializerNameSpaces-Array to prevent the serializer from adding namespaces to my xml elements.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> Serialize(WorkoutFile content, <span style="color:#66d9ef">string</span> filename)
{          
    <span style="color:#66d9ef">var</span> settings = <span style="color:#66d9ef">new</span> XmlWriterSettings();
    settings.Indent = <span style="color:#66d9ef">true</span>;
    settings.OmitXmlDeclaration = <span style="color:#66d9ef">true</span>;

    <span style="color:#66d9ef">var</span> serializer = <span style="color:#66d9ef">new</span> XmlSerializer(<span style="color:#66d9ef">typeof</span>(WorkoutFile), <span style="color:#66d9ef">new</span> Type[] { <span style="color:#66d9ef">typeof</span>(SteadyState), <span style="color:#66d9ef">typeof</span>(Interval), <span style="color:#66d9ef">typeof</span>(Ramp), <span style="color:#66d9ef">typeof</span>(Cooldown), <span style="color:#66d9ef">typeof</span>(Tag) });

    <span style="color:#66d9ef">using</span> (<span style="color:#66d9ef">var</span> writer = <span style="color:#66d9ef">new</span> StreamWriter(filename))
    <span style="color:#66d9ef">using</span> (<span style="color:#66d9ef">var</span> xmlWriter = XmlWriter.Create(writer, settings))
    {
        serializer.Serialize(xmlWriter, content, <span style="color:#66d9ef">new</span> XmlSerializerNamespaces(<span style="color:#66d9ef">new</span>[] { XmlQualifiedName.Empty }));
    }
}
</code></pre></div><p>And with this setup, I got the following result:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;workout_file&gt;</span>
  <span style="color:#f92672">&lt;author&gt;</span>Marcel Jurtz<span style="color:#f92672">&lt;/author&gt;</span>
  <span style="color:#f92672">&lt;name&gt;</span>A zwo file demo. No real workout, probably don&#39;t try to ride this.<span style="color:#f92672">&lt;/name&gt;</span>
  <span style="color:#f92672">&lt;description&gt;</span>ZWO File Demo<span style="color:#f92672">&lt;/description&gt;</span>
  <span style="color:#f92672">&lt;sportType&gt;</span>bike<span style="color:#f92672">&lt;/sportType&gt;</span>
  <span style="color:#f92672">&lt;tags&gt;</span>
    <span style="color:#f92672">&lt;tag</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;Test&#34;</span> <span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;tag</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;Demo&#34;</span> <span style="color:#f92672">/&gt;</span>
  <span style="color:#f92672">&lt;/tags&gt;</span>
  <span style="color:#f92672">&lt;workout&gt;</span>
    <span style="color:#f92672">&lt;Ramp</span> <span style="color:#a6e22e">Duration=</span><span style="color:#e6db74">&#34;300&#34;</span> <span style="color:#a6e22e">PowerLow=</span><span style="color:#e6db74">&#34;0.25&#34;</span> <span style="color:#a6e22e">PowerHigh=</span><span style="color:#e6db74">&#34;0.75&#34;</span> <span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;IntervalsT</span> <span style="color:#a6e22e">Repeat=</span><span style="color:#e6db74">&#34;10&#34;</span> <span style="color:#a6e22e">OnDuration=</span><span style="color:#e6db74">&#34;30&#34;</span> <span style="color:#a6e22e">OffDuration=</span><span style="color:#e6db74">&#34;30&#34;</span> <span style="color:#a6e22e">OnPower=</span><span style="color:#e6db74">&#34;1.3&#34;</span> <span style="color:#a6e22e">OffPower=</span><span style="color:#e6db74">&#34;0.5&#34;</span> <span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;SteadyState</span> <span style="color:#a6e22e">Duration=</span><span style="color:#e6db74">&#34;180&#34;</span> <span style="color:#a6e22e">Power=</span><span style="color:#e6db74">&#34;0.5&#34;</span> <span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;IntervalsT</span> <span style="color:#a6e22e">Repeat=</span><span style="color:#e6db74">&#34;10&#34;</span> <span style="color:#a6e22e">OnDuration=</span><span style="color:#e6db74">&#34;30&#34;</span> <span style="color:#a6e22e">OffDuration=</span><span style="color:#e6db74">&#34;30&#34;</span> <span style="color:#a6e22e">OnPower=</span><span style="color:#e6db74">&#34;1.3&#34;</span> <span style="color:#a6e22e">OffPower=</span><span style="color:#e6db74">&#34;0.5&#34;</span> <span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;SteadyState</span> <span style="color:#a6e22e">Duration=</span><span style="color:#e6db74">&#34;180&#34;</span> <span style="color:#a6e22e">Power=</span><span style="color:#e6db74">&#34;0.5&#34;</span> <span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;Cooldown</span> <span style="color:#a6e22e">Duration=</span><span style="color:#e6db74">&#34;480&#34;</span> <span style="color:#a6e22e">PowerLow=</span><span style="color:#e6db74">&#34;0.5&#34;</span> <span style="color:#a6e22e">PowerHigh=</span><span style="color:#e6db74">&#34;0.75&#34;</span> <span style="color:#f92672">/&gt;</span>
  <span style="color:#f92672">&lt;/workout&gt;</span>
<span style="color:#f92672">&lt;/workout_file&gt;</span>
</code></pre></div><p>Seems fine, so far. Of course I don&rsquo;t have any options included yet, but the base is working and can be easily extended. Also, the next step could be to integrate some kind of GUI to create and edit custom workouts, so stay tuned for that!</p>

</div>


    </main>

    
      
    
  </body>
</html>
