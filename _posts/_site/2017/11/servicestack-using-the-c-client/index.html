<p>After we covered the basics of ServiceStack in part one and how to set up a service in part two of this series. Today we’ll go through how the C#-Client can be utilized to make communication between applications even easier. The sourcecode for todays article is available <a href="https://github.com/MarcelJurtz/BlogPosts_ServiceStack/tree/master/Part_3_CSharp_Client">GitHub</a>. If you missed one of the previous parts, feel free to check out <a href="https://blog.mjurtz.com/2017/11/what-is-servicestack/">Part 1 – What is ServiceStack and why should I use it?</a> or <a href="https://blog.mjurtz.com/2017/11/servicestack-building-simple-service/">Part 2 – Building a Simple Service</a>.</p>

<h2 id="implementation-of-the-client">Implementation of the Client</h2>

<p>First, we will need to add a new project to our solution. This will function as the client-side application. For the sake of simplicity, I decided to create a console application. After the new project has been created, we have to install the ServiceStack nuget-package. Another required step is to add a reference to our base project. This allows gives us access to the request and response DTOs.</p>

<p>After the project has been set up, the C#-Client can easily be utilized. The following snippet is all that it takes to send a request to the service and save its response. Don’t forget to update the clients URL to match the address of your service.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="n">JsonServiceClient</span> <span class="n">jsonServiceClient</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">JsonServiceClient</span><span class="p">(</span><span class="s">"http://localhost:61401"</span><span class="p">);</span>
<span class="kt">var</span> <span class="n">response</span> <span class="p">=</span> <span class="n">jsonServiceClient</span><span class="p">.</span><span class="n">Post</span><span class="p">&lt;</span><span class="n">ExpenseResponse</span><span class="p">&gt;(</span><span class="k">new</span> <span class="n">Expense</span> <span class="p">{</span> <span class="n">Amount</span> <span class="p">=</span> <span class="m">500</span> <span class="p">});</span></code></pre></figure>

<p>In order to make the example a little more valuable, we will improve the service from the last part a little bit.</p>

<h2 id="service-improvements-using-sessions">Service Improvements: Using Sessions</h2>

<p>As you can see in the following snippet, I have installed a session mechanism that manages the current requests. I specified a general total of 1000, whereby each request reduces this amount by the requested withdrawals. Also, each request increments the request counter. I limit the amount of withdrawals to the total amount available. If more money is withdrawn, the service will not execute the request and the user will be informed. To keep track of the session data, I created another class called <em>TrackingData</em>, which is shown below the Post-method of our service.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">public</span> <span class="kt">object</span> <span class="nf">Post</span><span class="p">(</span><span class="n">Expense</span> <span class="n">request</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">Session</span> <span class="p">=</span> <span class="k">base</span><span class="p">.</span><span class="n">SessionBag</span><span class="p">;</span>

    <span class="kt">var</span> <span class="n">trackingData</span> <span class="p">=</span> <span class="p">(</span><span class="n">TrackingData</span><span class="p">)</span><span class="n">Session</span><span class="p">[</span><span class="s">"Expenses"</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">trackingData</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
        <span class="n">trackingData</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TrackingData</span> <span class="p">{</span> <span class="n">TotalBalance</span> <span class="p">=</span> <span class="m">1000</span><span class="p">,</span> <span class="n">WithdrawalsAmount</span> <span class="p">=</span> <span class="m">0</span> <span class="p">};</span>

    <span class="k">if</span><span class="p">(</span><span class="n">trackingData</span><span class="p">.</span><span class="n">TotalBalance</span> <span class="p">&gt;=</span> <span class="n">request</span><span class="p">.</span><span class="n">Amount</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">trackingData</span><span class="p">.</span><span class="n">Withdrawals</span> <span class="p">+=</span> <span class="n">request</span><span class="p">.</span><span class="n">Amount</span><span class="p">;</span>
        <span class="n">trackingData</span><span class="p">.</span><span class="n">TotalBalance</span> <span class="p">-=</span> <span class="n">request</span><span class="p">.</span><span class="n">Amount</span><span class="p">;</span>
        <span class="n">trackingData</span><span class="p">.</span><span class="n">WithdrawalsAmount</span><span class="p">++;</span>

        <span class="n">Session</span><span class="p">[</span><span class="s">"Expenses"</span><span class="p">]</span> <span class="p">=</span> <span class="n">trackingData</span><span class="p">;</span>

        <span class="k">return</span> <span class="k">new</span> <span class="n">ExpenseResponse</span>
        <span class="p">{</span>
            <span class="n">Amount</span> <span class="p">=</span> <span class="n">request</span><span class="p">.</span><span class="n">Amount</span><span class="p">,</span>
            <span class="n">Total</span> <span class="p">=</span> <span class="n">trackingData</span><span class="p">.</span><span class="n">TotalBalance</span><span class="p">,</span>
            <span class="n">WithdrawalsAmount</span> <span class="p">=</span> <span class="n">trackingData</span><span class="p">.</span><span class="n">WithdrawalsAmount</span><span class="p">,</span>
            <span class="n">Status</span> <span class="p">=</span> <span class="s">"OK"</span>
        <span class="p">};</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">ExpenseResponse</span>
        <span class="p">{</span>
            <span class="n">Amount</span> <span class="p">=</span> <span class="n">request</span><span class="p">.</span><span class="n">Amount</span><span class="p">,</span>
            <span class="n">Total</span> <span class="p">=</span> <span class="n">trackingData</span><span class="p">.</span><span class="n">TotalBalance</span><span class="p">,</span>
            <span class="n">WithdrawalsAmount</span> <span class="p">=</span> <span class="n">trackingData</span><span class="p">.</span><span class="n">WithdrawalsAmount</span><span class="p">,</span>
            <span class="n">Status</span> <span class="p">=</span> <span class="s">"Balance too low"</span>
        <span class="p">};</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Let’s add some further modification to be able to increase our withdrawals. These modification reads a users input as long as he enters valid integers. When entering anything else, the loop will exit and the program stops.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">public</span> <span class="k">class</span> <span class="nc">TrackingData</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">double</span> <span class="n">Withdrawals</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">double</span> <span class="n">TotalBalance</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">WithdrawalsAmount</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>With these adjustments it is possible to generate successive requests. After several requests, postman delivers a result similar to the following.</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
    </span><span class="s2">"Amount"</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w">
    </span><span class="s2">"Total"</span><span class="p">:</span><span class="w"> </span><span class="mi">600</span><span class="p">,</span><span class="w">
    </span><span class="s2">"Status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"OK"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"WithdrawalsAmount"</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<h2 id="further-shortcuts">Further Shortcuts</h2>

<p>Another small change I would like to make concerns the DTOs themselves. By specifying a return value using the IReturn interface, you do not need to specify the response type on the client side.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="na">[Route("/Expense")]</span>
<span class="na">[Route("/Expense/{Amount}")]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">Expense</span> <span class="p">:</span> <span class="n">IReturn</span><span class="p">&lt;</span><span class="n">ExpenseResponse</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">double</span> <span class="n">Amount</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span>
<span class="p">}</span>
    
<span class="k">public</span> <span class="k">class</span> <span class="nc">ExpenseResponse</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">double</span> <span class="n">Amount</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">double</span> <span class="n">Total</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="n">String</span> <span class="n">Status</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">WithdrawalsAmount</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>This change allows the usage of the client by following notation:</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="kt">var</span> <span class="n">response</span> <span class="p">=</span> <span class="n">jsonServiceClient</span><span class="p">.</span><span class="nf">Post</span><span class="p">(</span><span class="k">new</span> <span class="n">Expense</span> <span class="p">{</span> <span class="n">Amount</span> <span class="p">=</span> <span class="m">500</span> <span class="p">});</span></code></pre></figure>

<h2 id="final-updates-for-the-client">Final Updates for the Client</h2>

<p>The last change I want to make is to loop the user input, so that we can test the session mechanism in our console application. The following snippet waits for user input, as long as this input is a valid integer. If not, it breaks and the program terminates.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="n">JsonServiceClient</span> <span class="n">jsonServiceClient</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">JsonServiceClient</span><span class="p">(</span><span class="s">"http://localhost:61401"</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">userInput</span><span class="p">;</span>
<span class="k">while</span><span class="p">(</span><span class="n">Int32</span><span class="p">.</span><span class="nf">TryParse</span><span class="p">(</span><span class="n">Console</span><span class="p">.</span><span class="nf">ReadLine</span><span class="p">(),</span> <span class="k">out</span> <span class="n">userInput</span><span class="p">))</span> <span class="p">{</span>
    <span class="kt">var</span> <span class="n">response</span> <span class="p">=</span> <span class="n">jsonServiceClient</span><span class="p">.</span><span class="nf">Post</span><span class="p">(</span><span class="k">new</span> <span class="n">Expense</span> <span class="p">{</span> <span class="n">Amount</span> <span class="p">=</span> <span class="n">userInput</span> <span class="p">});</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="s">"Status: {0} - Withdrawals: {1} (Total: {2}, {3} Withdrawals)"</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="n">Status</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="n">Amount</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="n">Total</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="n">WithdrawalsAmount</span><span class="p">));</span>
<span class="p">}</span></code></pre></figure>

<p>The program does not contain any logic yet, so you can mess with it in different places. However, this basic example shows how easy it is to set up the C#-Client for ServiceStack and how to use it. In the next part, we will cover the basics of authentication and authorization, which allows us to increase our services security.</p>
